#!/bin/bash

if [ ! -d /mnt/c ]; then
  # Mac
  osascript -e 'tell application "System Events" to tell appearance preferences to set dark mode to not dark mode'

  if [ "$(osascript -e 'tell application "System Events" to tell appearance preferences to get dark mode')" == "true" ]; then
    osascript -e 'tell application "Terminal" to set current settings of tabs of windows to (first settings set whose name is "One Dark")'
  else
    osascript -e 'tell application "Terminal" to set current settings of tabs of windows to (first settings set whose name is "One Light")'
  fi
else
  # Windows in WSL
  WINHOME=$(wslpath "$(cmd.exe /C "echo %USERPROFILE%" 2>/dev/null | tr -d '\r' | tail -1)")

  if reg.exe query 'HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize' /v AppsUseLightTheme | grep -q 0x1; then
    useLightTheme=0
    sed -i 's/"colorScheme": "OneLight"/"colorScheme": "OneDark"/g' "$WINHOME/AppData/Local/Packages/Microsoft.WindowsTerminal_8wekyb3d8bbwe/LocalState/settings.json"
    sed -i 's/"colorScheme": "OneLight"/"colorScheme": "OneDark"/g' "$WINHOME/AppData/Local/Packages/Microsoft.WindowsTerminalPreview_8wekyb3d8bbwe/LocalState/settings.json"
  else
    useLightTheme=1
    sed -i 's/"colorScheme": "OneDark"/"colorScheme": "OneLight"/g' "$WINHOME/AppData/Local/Packages/Microsoft.WindowsTerminal_8wekyb3d8bbwe/LocalState/settings.json"
    sed -i 's/"colorScheme": "OneDark"/"colorScheme": "OneLight"/g' "$WINHOME/AppData/Local/Packages/Microsoft.WindowsTerminalPreview_8wekyb3d8bbwe/LocalState/settings.json"
  fi
  reg.exe add 'HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize' /v SystemUsesLightTheme /t REG_DWORD /f /d $useLightTheme > /dev/null
  reg.exe add 'HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize' /v AppsUseLightTheme /t REG_DWORD /f /d $useLightTheme > /dev/null
fi
